<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cqut.czb.bn.dao.mapper.mallPartnerManage.MallPartnerManageMapperExtra">
    <sql id="Base_Column_List" >
        (
            SELECT
                CASE

                    WHEN
                        ( ISNULL( t1.mall_partner ) OR t1.mall_partner = '' ) THEN
                        t1.user_id ELSE t1.mall_partner
                    END AS mall_partner,
                t1.user_id,
                t2.recharge_amount AS money,
                CASE
                    record_type
                    WHEN 1 THEN
                        1
                    WHEN 2 THEN
                        2
                    WHEN 3 THEN
                        2
                    END AS type
            FROM
                czb_user t1
                    LEFT JOIN czb_direct_charging_order t2 ON t1.user_id = t2.user_id
        ) UNION ALL
        (
            SELECT
                CASE

                    WHEN
                        ( ISNULL( t1.mall_partner ) OR t1.mall_partner = '' ) THEN
                        t1.user_id ELSE t1.mall_partner
                    END AS mall_partner,
                t1.user_id,
                t2.price AS money,
                CASE
                    record_type
                    WHEN 1 THEN
                        3
                    WHEN 2 THEN
                        4
                    END AS type
            FROM
                czb_user t1
                    LEFT JOIN czb_h5_stock t2 ON t1.user_id = t2.user_id
        ) UNION ALL
        (
            SELECT
                CASE

                    WHEN
                        ( ISNULL( t1.mall_partner ) OR t1.mall_partner = '' ) THEN
                        t1.user_id ELSE t1.mall_partner
                    END AS mall_partner,
                t1.user_id,
                t2.amount AS money,
                5 AS type
            FROM
                czb_user t1
                    LEFT JOIN czb_integral_purchase_record t2 ON t1.user_id = t2.user_id
        )
    </sql>
    <select id="statisticsMoney" resultType="double">
        SELECT SUM(fnd.totalMoney) FROM
        (SELECT
        t1.user_id userId,
        t1.user_account userAccount,
        t1.create_at createAt,
        t2.totalMoney
        FROM
        (
        SELECT
        t1.user_id,
        t1.user_account,
        t1.create_at
        FROM
        czb_user t1
        LEFT JOIN czb_user_role t2 ON t1.user_id = t2.user_id
        LEFT JOIN czb_role t3 ON t3.role_id = t2.role_id
        WHERE
        t3.role_name = '商城合伙人'
        ) t1
        LEFT JOIN (
        SELECT
        fnd.mall_partner,
        SUM(IFNULL(fnd.money,0)) totalMoney
        FROM
        (<include refid="Base_Column_List" />) AS fnd
        GROUP BY
        fnd.mall_partner
        ) t2 ON t1.user_id = t2.mall_partner) AS fnd
    </select>

    <select id="selectMallPartnerList" parameterType="com.cqut.czb.bn.entity.dto.mallPartnerManage.MallPartnerDTO" resultType="com.cqut.czb.bn.entity.dto.mallPartnerManage.MallPartnerDTO">
        SELECT
        t1.user_id userId,
        t1.user_account userAccount,
        t1.create_at createAt,
        t2.totalMoney
        FROM
        (
        SELECT
        t1.user_id,
        t1.user_account,
        t1.create_at
        FROM
        czb_user t1
        LEFT JOIN czb_user_role t2 ON t1.user_id = t2.user_id
        LEFT JOIN czb_role t3 ON t3.role_id = t2.role_id
        WHERE
        t3.role_name = '商城合伙人'
        ) t1
        LEFT JOIN (
        SELECT
        fnd.mall_partner,
        SUM(IFNULL(fnd.money,0)) totalMoney
        FROM
        (<include refid="Base_Column_List" />) AS fnd
        GROUP BY
        fnd.mall_partner
        ) t2 ON t1.user_id = t2.mall_partner
        WHERE 1 = 1
        <if test="userAccount != null and userAccount != ''">
            AND t1.user_account like concat('%',#{userAccount,jdbcType = VARCHAR},'%')
        </if>
        <if test="startTime != null and endTime != null">
            AND (t1.create_at &gt;= #{startTime}
            AND t1.create_at &lt;= #{endTime})
        </if>
        ORDER BY
        t1.create_at DESC
    </select>

    <select id="selectMallPartnerConsumptionDetails" parameterType="com.cqut.czb.bn.entity.entity.User" resultType="com.cqut.czb.bn.entity.dto.mallPartnerManage.ConsumptionDetailsDTO">
        SELECT
            SUM( fnd.money ) AS totalMoney,
            fnd.type
        FROM
            (<include refid="Base_Column_List" />) AS fnd
        WHERE fnd.mall_partner = #{userId,jdbcType=VARCHAR} or fnd.user_id = #{userId,jdbcType=VARCHAR}
        GROUP BY
            fnd.type
    </select>
</mapper>
