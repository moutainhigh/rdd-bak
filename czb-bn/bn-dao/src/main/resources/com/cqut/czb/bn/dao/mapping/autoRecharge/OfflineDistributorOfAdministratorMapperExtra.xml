<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cqut.czb.bn.dao.mapper.autoRecharge.OfflineDistributorOfAdministratorMapperExtra">
    <select id="getRechargeTableList" parameterType="com.cqut.czb.bn.entity.dto.AccountRechargeDTO" resultType="com.cqut.czb.bn.entity.dto.AccountRechargeDTO">
        SELECT
        b.user_account AS account,
        a.amount AS rechargeAmount,
        ( a.amount + a.before_balance ) AS balance,
        a.recharge_time AS rechargeTime
        FROM
        `czb_offline_distributor_records` AS a
        JOIN czb_user AS b ON a.buyer_id = b.user_id
        <where>
        <if test="account != null and account != ''">
            and b.user_account = #{account,jdbcType=VARCHAR}
        </if>
        <if test="startTime!= null and startTime!= '' and endTime!= null and endTime!= ''">
            AND ( a.create_at BETWEEN #{startTime} AND #{endTime} )
        </if>
    </where>
        ORDER BY
        rechargeTime DESC
    </select>

    <select id="getOfflineConsumptionList" parameterType="com.cqut.czb.bn.entity.dto.OfflineConsumptionDTO" resultType="com.cqut.czb.bn.entity.dto.OfflineConsumptionDTO">
        SELECT
            a.petrol_num AS petrolNum,
            a.turnover_amount AS amount,
            a.state AS state,
            b.user_account AS account,
            a.transaction_time AS rechargeTime
        FROM
            `czb_petrol_sales_records` AS a
            JOIN czb_user AS b ON a.buyer_id = b.user_id
        <where>
            a.record_type = 3
            <if test="petrolNum != null and account != ''">
              and a.petrol_num =  #{petrolNum,jdbcType=VARCHAR}
            </if>
            <if test="state != null and account != ''">
                and a.state =  #{state}
            </if>
            <if test="account != null and account != ''">
                and b.user_account = #{account,jdbcType=VARCHAR}
            </if>
            <if test="startTime!= null and startTime!= '' and endTime!= null and endTime!= ''">
                AND ( a.transaction_time BETWEEN #{startTime} AND #{endTime} )
            </if>
        </where>
        ORDER BY
            rechargeTime DESC
    </select>

    <select id="getOfflineClientList" parameterType="com.cqut.czb.bn.entity.dto.OfflineClientDTO" resultType="com.cqut.czb.bn.entity.dto.OfflineClientDTO">
        SELECT
            b.user_account AS account,
            c.other_income AS balance,
            a.create_at AS registerTime,
            totalConsumption,
            totalRecharge
        FROM
            czb_user_role AS a
            JOIN czb_user AS b ON a.user_id = b.user_id
            JOIN czb_user_income_info AS c ON a.user_id = c.user_id
            LEFT JOIN (
        SELECT
            buyer_id,
            sum( turnover_amount ) totalConsumption
        FROM
            czb_petrol_sales_records
        WHERE
            buyer_id = ( SELECT DISTINCT buyer_id FROM czb_petrol_sales_records JOIN czb_user_role ON czb_petrol_sales_records.buyer_id = czb_user_role.user_id WHERE role_id = '12919772806795175' )
            AND record_type = 3
        GROUP BY
            buyer_id
            ) AS d ON a.user_id = d.buyer_id
            LEFT JOIN (
        SELECT
            buyer_id,
            sum( amount ) totalRecharge
        FROM
            czb_offline_distributor_records
        WHERE
            buyer_id = ( SELECT DISTINCT buyer_id FROM czb_offline_distributor_records JOIN czb_user_role ON czb_offline_distributor_records.buyer_id = czb_user_role.user_id WHERE role_id = '12919772806795175' )
        GROUP BY
            buyer_id
            ) AS e ON a.user_id = e.buyer_id
        <where>
            a.role_id = '12919772806795175'
            <if test="account != null and account != ''">
                and b.user_account = #{account,jdbcType=VARCHAR}
            </if>
            <if test="startTime!= null and startTime!= '' and endTime!= null and endTime!= ''">
                AND ( a.create_at BETWEEN #{startTime} AND #{endTime} )
            </if>
        </where>
        ORDER BY
            a.create_at DESC
    </select>

    <select id="getRechargeAccountList" parameterType="java.lang.String">
        SELECT
            b.user_account
        FROM
            `czb_user_role` AS a
            JOIN czb_user AS b ON a.user_id = b.user_id
        <where>
            a.role_id = '12919772806795175'
        </where>
    </select>

    <select id="getAccountBalance" parameterType="java.lang.String" resultType="java.lang.Double">
        SELECT
            a.other_income
        FROM
            `czb_user_income_info` AS a
            JOIN czb_user AS b ON a.user_id = b.user_id
            JOIN czb_user_role AS c ON a.user_id = c.user_id
        <where>
            c.role_id = '12919772806795175'
        </where>
    </select>

    <select id="selectAccount" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT
            count( * )
        FROM
            `czb_user_role` AS a
            JOIN czb_user AS b ON a.user_id = b.user_id
        <where>
            a.role_id = '12919772806795175'
            AND b.user_account = #{account,jdbcType = VARCHAR}
        </where>
    </select>
    
    <insert id="insertIncomeInfo" parameterType="com.cqut.czb.bn.entity.dto.RechargeDTO">

    </insert>
</mapper>