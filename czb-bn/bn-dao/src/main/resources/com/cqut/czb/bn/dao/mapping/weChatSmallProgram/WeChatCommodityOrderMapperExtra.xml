<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cqut.czb.bn.dao.mapper.weChatSmallProgram.WeChatCommodityOrderMapperExtra" >
  <resultMap id="OrderDetail" type="com.cqut.czb.bn.entity.dto.WeChatCommodity.WCPCommodityOrderDTO">
    <id column="orderId" property="orderId" jdbcType="VARCHAR" />
    <result column="commodityTitle" property="commodityTitle" jdbcType="VARCHAR" />
    <result column="commodityInfo" property="commodityInfo" jdbcType="VARCHAR" />
    <result column="actualPrice" property="actualPrice" jdbcType="DOUBLE" />
    <result column="commodityId" property="commodityId" jdbcType="VARCHAR" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="commodityNum" property="commodityNum" jdbcType="INTEGER" />
    <result column="electronicCode" property="electronicCode" jdbcType="VARCHAR" />
    <result column="QRcode" property="QRcode" jdbcType="VARCHAR" />
    <result column="phone" property="phone" jdbcType="VARCHAR" />
    <result column="commoditySource" property="commoditySource" jdbcType="VARCHAR" />
    <result column="commodityType" property="commodityType" jdbcType="INTEGER" />
    <result column="deliveryState" property="deliveryState" jdbcType="INTEGER" />
    <result column="deliveryNum" property="deliveryNum" jdbcType="VARCHAR" />
    <result column="deliveryCompany" property="deliveryCompany" jdbcType="VARCHAR" />
    <result column="addressDetail" property="addressDetail" jdbcType="VARCHAR" />
    <result column="contactNumber" property="contactNumber" jdbcType="VARCHAR" />
    <result column="receiver" property="receiver" jdbcType="VARCHAR" />
    <result column="commodityImgId" property="commodityImgId" jdbcType="VARCHAR" />
    <collection property="commodityImgList" column="commodityImgId" javaType="list" select="selectCommodityImgList"/>
  </resultMap>

  <select id="selectCurrentOrder" parameterType="java.lang.String" resultMap="OrderDetail">
    SELECT
      czb_wechat_commodity_order.order_id orderId,
      czb_wechat_commodity.commodity_title commodityTitle,
      czb_wechat_commodity.commodity_info commodityInfo,
      czb_wechat_commodity_order.actual_price actualPrice,
      czb_wechat_commodity_order.commodity_id commodityId,
      czb_wechat_commodity_order.remark remark,
      czb_wechat_commodity_order.commodity_num commodityNum,
      czb_wechat_commodity_order.electronic_code electronicCode,
      czb_wechat_commodity_order.qrcode QRcode,
      czb_wechat_commodity_order.phone phone,
      czb_wechat_commodity.original_price originalPrice,
      czb_wechat_commodity_order.create_at createAt,
      czb_wechat_commodity_order.commodity_source commoditySource,
      czb_wechat_commodity_order.commodity_type commodityType,
      czb_wechat_goods_delivery_records.delivery_state deliveryState,
      czb_wechat_goods_delivery_records.delivery_num deliveryNum,
      czb_wechat_goods_delivery_records.delivery_company deliveryCompany,
      CONCAT_WS( ' ', czb_address.province, czb_address.city, czb_address.area, czb_address.detail ) addressDetail,
      czb_address.contact_number contactNumber,
      czb_address.receiver receiver,
      commodity_img_id commodityImgId
    FROM
	  czb_wechat_commodity_order
	  LEFT JOIN czb_wechat_commodity ON czb_wechat_commodity.commodity_id = czb_wechat_commodity_order.commodity_id
	  LEFT JOIN czb_wechat_goods_delivery_records ON czb_wechat_commodity_order.order_id = czb_wechat_goods_delivery_records.order_id
	  LEFT JOIN czb_address ON czb_address.address_id = czb_wechat_commodity_order.address_id
    WHERE
      czb_wechat_commodity_order.user_id = #{userId, jdbcType = VARCHAR}
      AND pay_status = 1
    ORDER BY
      czb_wechat_commodity_order.create_at DESC
      LIMIT 1
  </select>

  <select id="selectCommodityImgList" resultType="java.lang.String">
    SELECT
      save_path
    FROM
      czb_file_function
    LEFT JOIN czb_file on czb_file_function.file_id = czb_file.file_id
    WHERE
      czb_file_function.local_id = #{commodityImgId, jdbcType = VARCHAR}
  </select>

  <select id="selectAllCommodityOrder" parameterType="java.lang.String" resultMap="OrderDetail">
    SELECT
      czb_wechat_commodity_order.order_id orderId,
      czb_wechat_commodity.commodity_title commodityTitle,
      czb_wechat_commodity.commodity_info commodityInfo,
      czb_wechat_commodity_order.actual_price actualPrice,
      czb_wechat_commodity_order.commodity_id commodityId,
      czb_wechat_commodity_order.remark remark,
      czb_wechat_commodity_order.commodity_num commodityNum,
      czb_wechat_commodity_order.electronic_code electronicCode,
      czb_wechat_commodity_order.qrcode QRcode,
      czb_wechat_commodity_order.phone phone,
      czb_wechat_commodity_order.commodity_source commoditySource,
      czb_wechat_commodity_order.commodity_type commodityType,
      czb_wechat_goods_delivery_records.delivery_state deliveryState,
      czb_wechat_goods_delivery_records.delivery_num deliveryNum,
      czb_wechat_goods_delivery_records.delivery_company deliveryCompany,
      CONCAT_WS( ' ', czb_address.province, czb_address.city, czb_address.area, czb_address.detail ) addressDetail,
      czb_address.contact_number contactNumber,
      czb_address.receiver receiver,
      czb_wechat_commodity.original_price originalPrice,
      czb_wechat_commodity_order.create_at createAt,
      commodity_img_id commodityImgId
    FROM
	  czb_wechat_commodity_order
	  LEFT JOIN czb_wechat_commodity ON czb_wechat_commodity.commodity_id = czb_wechat_commodity_order.commodity_id
	  LEFT JOIN czb_wechat_goods_delivery_records ON czb_wechat_commodity_order.order_id = czb_wechat_goods_delivery_records.order_id
	  LEFT JOIN czb_address ON czb_address.address_id = czb_wechat_commodity_order.address_id
    WHERE
      czb_wechat_commodity_order.user_id = #{userId, jdbcType = VARCHAR}
      AND pay_status = 1
    ORDER BY
      czb_wechat_commodity_order.create_at DESC
  </select>

    <select id="selectOneCommodityOrderById" resultMap="OrderDetail">
    SELECT
      czb_wechat_commodity_order.order_id orderId,
      czb_wechat_commodity.commodity_title commodityTitle,
      czb_wechat_commodity.commodity_info commodityInfo,
      czb_wechat_commodity_order.actual_price actualPrice,
      czb_wechat_commodity_order.commodity_id commodityId,
      czb_wechat_commodity_order.remark remark,
      czb_wechat_commodity_order.commodity_num commodityNum,
      czb_wechat_commodity_order.electronic_code electronicCode,
      czb_wechat_commodity_order.qrcode QRcode,
      czb_wechat_commodity_order.phone phone,
      czb_wechat_commodity.original_price originalPrice,
      czb_wechat_commodity_order.create_at createAt,
      czb_wechat_commodity_order.commodity_source commoditySource,
      czb_wechat_commodity_order.commodity_type commodityType,
      czb_wechat_goods_delivery_records.delivery_state deliveryState,
      czb_wechat_goods_delivery_records.delivery_num deliveryNum,
      czb_wechat_goods_delivery_records.delivery_company deliveryCompany,
      CONCAT_WS( ' ', czb_address.province, czb_address.city, czb_address.area, czb_address.detail ) addressDetail,
      czb_address.contact_number contactNumber,
      czb_address.receiver receiver,
      commodity_img_id commodityImgId
    FROM
	  czb_wechat_commodity_order
	  LEFT JOIN czb_wechat_commodity ON czb_wechat_commodity.commodity_id = czb_wechat_commodity_order.commodity_id
	  LEFT JOIN czb_wechat_goods_delivery_records ON czb_wechat_commodity_order.order_id = czb_wechat_goods_delivery_records.order_id
	  LEFT JOIN czb_address ON czb_address.address_id = czb_wechat_commodity_order.address_id
    WHERE
      czb_wechat_commodity_order.user_id = #{userId, jdbcType = VARCHAR}
      AND pay_status = 1
      AND czb_wechat_commodity_order.order_id = #{orderId, jdbcType = VARCHAR}
    ORDER BY
      czb_wechat_commodity_order.create_at DESC
    </select>

  <update id="updateCommodityDeliveryState">
    UPDATE czb_wechat_goods_delivery_records,
      czb_wechat_commodity_order
    SET delivery_state = 2
    WHERE
	    czb_wechat_goods_delivery_records.order_id = czb_wechat_commodity_order.order_id
	AND czb_wechat_goods_delivery_records.order_id = #{orderId, jdbcType = VARCHAR}
	AND czb_wechat_commodity_order.user_id = #{userId, jdbcType = VARCHAR}
	AND czb_wechat_goods_delivery_records.delivery_state = 1
  </update>
</mapper>