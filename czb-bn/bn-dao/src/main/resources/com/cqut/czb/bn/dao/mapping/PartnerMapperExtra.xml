<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cqut.czb.bn.dao.mapper.PartnerMapperExtra" >
    <!--全部子级-->
    <resultMap id="ChildInfoMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="moneys"  property="totalMoney" jdbcType="DOUBLE"/>
        <collection property="childPartner" column="user_id" ofType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" select="selectPartnerChildInfo"/>
    </resultMap>
    <select id="selectPartnerChildInfo" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultMap="ChildInfoMap">
        SELECT
        a.user_id,
        partner,
        a.superior_user,
        COUNT(b.money) AS moneys
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record b on a.user_id = b.user_id
        WHERE
        superior_user = #{userId,jdbcType=VARCHAR}
        GROUP BY
        a.user_id
    </select>

    <!--限制时间查找子级-->
    <resultMap id="ChildWithTimeMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerChildInfoWithTime"  resultMap="ChildWithTimeMap">
        SELECT
        a.user_id,
        partner,
        a.superior_user,
        a.create_at
        FROM
        czb_user a
        WHERE
        a.user_id in <foreach collection="list" item="item" index="index"
                              separator="," open="(" close=")">
        #{item.userId,jdbcType=VARCHAR}
    </foreach>
        <if test="partner.monthTime!=null">
            AND DATE_FORMAT(a.create_at,'%Y-%m') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m')
        </if>
        GROUP BY
        a.user_id
    </select>

    <resultMap id="ChildWithDayMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerChildInfoWithDay"  resultMap="ChildWithDayMap">
        SELECT
        a.user_id,
        partner,
        a.superior_user,
        a.create_at
        FROM
        czb_user a
        WHERE
        a.user_id in <foreach collection="list" item="item" index="index"
                              separator="," open="(" close=")">
        #{item.userId,jdbcType=VARCHAR}
    </foreach>
        <if test="partner.monthTime!=null">
            AND DATE_FORMAT(a.create_at,'%Y-%m-%d') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
        GROUP BY
        a.user_id
    </select>

    <!--查询指定月份中有消费记录的子用户-->
    <resultMap id="ChildWithMoneyMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerChildInfoWithMoney" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultMap="ChildWithMoneyMap">
        SELECT
        a.user_id,
        a.partner,
        a.create_at,
        b.money
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record b on  a.user_id=b.user_id
        WHERE
        a.user_id in <foreach collection="list" item="item" index="index"
                               separator="," open="(" close=")">
        #{item.userId,jdbcType=VARCHAR}
    </foreach>
        AND DATE_FORMAT(a.create_at,'%Y-%m') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m')
        AND DATE_FORMAT(b.create_at,'%Y-%m') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m')
        AND b.record_id is NOT NULL
    </select>

    <resultMap id="ChildWithDayMoneyMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerChildWithDayMoney" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultMap="ChildWithDayMoneyMap">
        SELECT
        a.user_id,
        a.partner,
        a.create_at,
        b.money
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record b on  a.user_id=b.user_id
        WHERE
        a.user_id in <foreach collection="list" item="item" index="index"
                              separator="," open="(" close=")">
        #{item.userId,jdbcType=VARCHAR}
    </foreach>
        AND DATE_FORMAT(a.create_at,'%Y-%m-%d') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        AND DATE_FORMAT(b.create_at,'%Y-%m-%d') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        AND b.record_id is NOT NULL
    </select>



    <resultMap id="PartnerMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="user_account" property="userAccount" jdbcType="VARCHAR"/>
        <result column="mission_start_time" property="missionStartTime" jdbcType="TIMESTAMP" />
        <result column="mission_end_time" property="missionEndTime" jdbcType="TIMESTAMP" />
        <result column="target_promotion_number" property="targetPromotionNumber" jdbcType="INTEGER" />
        <result column="target_new_consumer" property="targetNewConsumer" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerInfo" resultMap="PartnerMap" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO"  >
    SELECT
        a.user_id,
        a.partner,
        a.user_account,
        a.mission_start_time,
        a.mission_end_time,
        b.target_new_consumer,
        b.target_promotion_number
    FROM
        czb_user a
    LEFT JOIN czb_indicator_record b on  a.user_id=b.user_id
    <where>
        <if test="userId!=null and userId!=''">
        a.user_id = #{userId,jdbcType=VARCHAR}
        </if>
    </where>
    </select>

    <resultMap id="PartnerChildMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="user_account" property="userAccount" jdbcType="VARCHAR"/>
        <result column="near_time" property="nearTime" jdbcType="TIMESTAMP" />
       <result column="total_count" property="totalCount" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectNextChild" resultMap="PartnerChildMap" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO"  >
        SELECT
        a.user_id,
        a.user_account,
        a.partner,
        a.superior_user,
        COUNT(b.user_id) as total_count,
        SUM(c.create_at) AS near_time
        FROM
        czb_user a
        LEFT JOIN czb_user b ON a.user_id = b.superior_user
        LEFT JOIN czb_consumption_record c ON a.user_id =c.user_id
        <where>
            <if test="userId!=null and userId!=''">
                a.superior_user = #{userId,jdbcType=VARCHAR}
            </if>
        </where>
        GROUP BY a.user_id
    </select>


    <resultMap id="HistoryInfoMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="mission_start_time" property="missionStartTime" jdbcType="TIMESTAMP" />
        <result column="mission_end_time" property="missionEndTime" jdbcType="TIMESTAMP" />
        <result column="target_promotion_number" property="targetPromotionNumber" jdbcType="INTEGER" />
        <result column="actual_promotion_number" property="actualPromotionNumber" jdbcType="INTEGER" />
        <result column="target_new_consumer" property="targetNewConsumer" jdbcType="INTEGER" />
        <result column="actual_new_consumer" property="actualNewConsumer" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectHistoryInfo" resultMap="HistoryInfoMap" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
        SELECT
            a.user_id,
            a.partner,
            a.mission_start_time,
            a.mission_end_time,
            b.target_new_consumer,
            b.actual_new_consumer,
            b.target_promotion_number,
            b.actual_promotion_number
        FROM
            czb_user a
        LEFT JOIN czb_indicator_record b on  a.user_id=b.user_id
        WHERE
            a.user_id = #{userId,jdbcType=VARCHAR}
        AND DATE_FORMAT(b.indicator_begin_time,'%Y-%m') = DATE_FORMAT(#{monthTime,jdbcType=TIMESTAMP},'%Y-%m')
    </select>
</mapper>