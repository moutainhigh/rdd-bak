<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cqut.czb.bn.dao.mapper.PartnerMapperExtra" >

    <update id="addChildPromotion">
        UPDATE czb_indicator_record a LEFT JOIN czb_user b ON a.user_id= b.user_id
        SET actual_promotion_number = actual_promotion_number + 1,a.update_at=now()
        WHERE
         DATE_FORMAT(indicator_begin_time,'%Y-%m-%d') &lt;= DATE_FORMAT(#{monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        AND DATE_FORMAT(indicator_end_time,'%Y-%m-%d')>= DATE_FORMAT(#{monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        AND partner!=0
        <if test="firstPartner!=null and secondPartner==null">
            AND a.user_id = #{firstPartner,jdbcType=VARCHAR}
        </if>
        <if test="firstPartner==null and secondPartner!=null">
            AND a.user_id = #{secondPartner,jdbcType=VARCHAR}
        </if>
        <if test="firstPartner!=null and secondPartner!=null">
            AND (a.user_id = #{secondPartner,jdbcType=VARCHAR} OR a.user_id = #{firstPartner,jdbcType=VARCHAR})
        </if>
    </update>

    <update id="addChildConsumer">
        UPDATE czb_indicator_record a LEFT JOIN czb_user b ON a.user_id= b.user_id
        SET actual_new_consumer = actual_new_consumer + 1,a.update_at=now()
        WHERE
         DATE_FORMAT(indicator_begin_time,'%Y-%m-%d') &lt;= DATE_FORMAT(#{monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        AND DATE_FORMAT(indicator_end_time,'%Y-%m-%d')>= DATE_FORMAT(#{monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        AND partner!=0
        <if test="firstPartner!=null and secondPartner==null">
            AND a.user_id = #{firstPartner,jdbcType=VARCHAR}
        </if>
        <if test="firstPartner==null and secondPartner!=null">
            AND a.user_id = #{secondPartner,jdbcType=VARCHAR}
        </if>
        <if test="firstPartner!=null and secondPartner!=null">
            AND (a.user_id = #{secondPartner,jdbcType=VARCHAR} OR a.user_id = #{firstPartner,jdbcType=VARCHAR})
        </if>
    </update>

    <!--全部子级-->
    <resultMap id="ChildInMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="user_account" property="userAccount" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="moneys"  property="totalMoney" jdbcType="DOUBLE"/>
        <collection property="childPartner" column="user_id" ofType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" select="selectPartnerChildInfoTest"/>
    </resultMap>
    <select id="selectPartnerChildInfoTest" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultMap="ChildInMap">
        SELECT
        a.user_id,
        a.user_account,
        partner,
        a.superior_user,
        sum(b.money) AS moneys
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record b on a.user_id = b.user_id
        WHERE
        superior_user = #{userId,jdbcType=VARCHAR}
        GROUP BY
        a.user_id
    </select>


    <resultMap id="ChildInfoMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="user_account" property="userAccount" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="moneys"  property="totalMoney" jdbcType="DOUBLE"/>
    </resultMap>
    <select id="selectPartnerChildInfo" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultMap="ChildInfoMap">
        SELECT
        a.user_id,
        a.user_account,
        partner,
        sum(b.money) AS moneys
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record b on a.user_id = b.user_id
        WHERE
        first_level_partner = #{userId,jdbcType=VARCHAR} OR second_level_partner = #{userId,jdbcType=VARCHAR}
        GROUP BY
        a.user_id
    </select>



    <!--全部是合伙人的父级-->
    <resultMap id="AllPartnerInfoMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="superior_user" property="userId" jdbcType="VARCHAR" />
        <result column="first_level_partner" property="firstPartner" jdbcType="VARCHAR"/>
        <result column="second_level_partner" property="secondPartner" jdbcType="VARCHAR"/>
    </resultMap>
    <select id="selectAllPartnerInfo" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultMap="AllPartnerInfoMap">
        SELECT
        superior_user,
        first_level_partner,
        second_level_partner
        FROM
        czb_user
        WHERE
        user_id = #{userId,jdbcType=VARCHAR} AND (first_level_partner is not null OR second_level_partner IS  NOT NULL)
    </select>

    <!--限制时间查找子级-->
    <resultMap id="ChildWithTimeMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerChildInfoWithTime"  resultMap="ChildWithTimeMap">
        SELECT
        a.user_id,
        partner,
        a.superior_user,
        a.create_at
        FROM
        czb_user a
        WHERE
        a.user_id in <foreach collection="list" item="item" index="index"
                              separator="," open="(" close=")">
        #{item.userId,jdbcType=VARCHAR}
    </foreach>
        <if test="partner.monthTime!=null">
            AND DATE_FORMAT(a.create_at,'%Y-%m') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m')
        </if>
        GROUP BY
        a.user_id
    </select>

    <resultMap id="ChildWithDayMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerChildInfoWithDay"  resultMap="ChildWithDayMap">
        SELECT
        a.user_id,
        partner,
        a.superior_user,
        a.create_at
        FROM
        czb_user a
        WHERE
        a.user_id in <foreach collection="list" item="item" index="index"
                              separator="," open="(" close=")">
        #{item.userId,jdbcType=VARCHAR}
    </foreach>
        <if test="partner.monthTime!=null">
            AND DATE_FORMAT(a.create_at,'%Y-%m-%d') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
        GROUP BY
        a.user_id
    </select>

    <!--查询指定月份中有消费记录的子用户-->
    <resultMap id="ChildWithMoneyMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerChildInfoWithMoney" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultMap="ChildWithMoneyMap">
        SELECT
        a.user_id,
        a.partner,
        a.create_at,
        b.money
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record b on  a.user_id=b.user_id
        WHERE
        a.user_id in <foreach collection="list" item="item" index="index"
                               separator="," open="(" close=")">
        #{item.userId,jdbcType=VARCHAR}
    </foreach>
        AND DATE_FORMAT(b.create_at,'%Y-%m') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m')
        AND b.record_id is NOT NULL
    </select>

    <resultMap id="ChildWithDayMoneyMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerChildWithDayMoney" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultMap="ChildWithDayMoneyMap">
        SELECT
        a.user_id,
        a.partner,
        a.create_at
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record b on  a.user_id=b.user_id
        WHERE
        a.user_id in <foreach collection="list" item="item" index="index"
                              separator="," open="(" close=")">
        #{item.userId,jdbcType=VARCHAR}
    </foreach>
        AND DATE_FORMAT(b.create_at,'%Y-%m-%d') = DATE_FORMAT(#{partner.monthTime,jdbcType=TIMESTAMP},'%Y-%m-%d')
        AND b.record_id is NOT NULL
        GROUP BY a.user_id
    </select>

    <select id="selectPartner" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        SELECT
                a.user_id as userId,
                a.partner,
                a.user_account as userAccount
            FROM
                czb_user a
        WHERE a.user_id = #{userId,jdbcType=VARCHAR}
    </select>

    <resultMap id="PartnerMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="user_account" property="userAccount" jdbcType="VARCHAR"/>
        <result column="mission_start_time" property="missionStartTime" jdbcType="TIMESTAMP" />
        <result column="mission_end_time" property="missionEndTime" jdbcType="TIMESTAMP" />
        <result column="target_promotion_number" property="targetPromotionNumber" jdbcType="INTEGER" />
        <result column="target_new_consumer" property="targetNewConsumer" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectPartnerInfo" resultMap="PartnerMap" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO"  >
    SELECT
        a.user_id,
        a.partner,
        a.user_account,
        a.mission_start_time,
        a.mission_end_time,
        b.target_new_consumer,
        b.target_promotion_number
    FROM
        czb_user a
    LEFT JOIN czb_indicator_record b on  a.user_id=b.user_id
    <where>
        <if test="userId!=null and userId!=''">
        a.user_id = #{userId,jdbcType=VARCHAR}
        </if>
        <if test="monthTime!=null">
            AND DATE_FORMAT(b.indicator_begin_time,'%Y-%m') = DATE_FORMAT(#{monthTime,jdbcType=TIMESTAMP},'%Y-%m')
        </if>
    </where>
    </select>

    <select id="selectChildByName" resultMap="PartnerChildMap" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO"  >
        SELECT
        a.user_id,
        a.user_account,
        a.partner,
        a.superior_user,
        COUNT(b.user_id) as total_count
        FROM
        czb_user a
        LEFT JOIN czb_user b ON a.user_id = b.superior_user
        <where>
            <if test="userAccount!=null and userAccount!=''">
                (SUBSTR(a.user_account,1,3) LIKE CONCAT('%',#{userAccount,jdbcType=VARCHAR},'%') OR  SUBSTR(a.user_account,8,4) LIKE CONCAT('%',#{userAccount,jdbcType=VARCHAR},'%'))
            </if>
        </where>
        GROUP BY a.user_id
    </select>

    <select id="selectChildMoneyByName" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
        SELECT
        a.user_id as userId,
        a.user_account as userAccount,
        a.partner,
        SUM(c.money) as totalMoney,
        MAX(c.create_at) AS nearTime
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record c ON a.user_id =c.user_id
        <where>
            <if test="userAccount!=null and userAccount!=''">
                (SUBSTR(user_account,1,3) LIKE CONCAT('%',#{userAccount,jdbcType=VARCHAR},'%') OR  SUBSTR(user_account,8,4) LIKE CONCAT('%',#{userAccount,jdbcType=VARCHAR},'%'))
            </if>
        </where>
        GROUP BY a.user_id
    </select>


    <resultMap id="PartnerChildMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="user_account" property="userAccount" jdbcType="VARCHAR"/>
        <result column="near_time" property="nearTime" jdbcType="TIMESTAMP" />
       <result column="total_count" property="totalCount" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectNextChild" resultMap="PartnerChildMap" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO"  >
        SELECT
        a.user_id,
        a.user_account,
        a.partner,
        a.superior_user,
        COUNT(b.user_id) as total_count
        FROM
        czb_user a
        LEFT JOIN czb_user b ON a.user_id = b.superior_user
        <where>
            <if test="userId!=null and userId!=''">
                a.superior_user = #{userId,jdbcType=VARCHAR}
            </if>
        </where>
        GROUP BY a.user_id
    </select>

    <select id="selectNextChildMoney" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
        SELECT
        a.user_id as userId,
        a.user_account as userAccount,
        a.partner,
        SUM(c.money) as totalMoney,
        MAX(c.create_at) AS nearTime
        FROM
        czb_user a
        LEFT JOIN czb_consumption_record c ON a.user_id =c.user_id
        <where>
            <if test="userId!=null and userId!=''">
                a.superior_user = #{userId,jdbcType=VARCHAR}
            </if>
        </where>
        GROUP BY a.user_id
    </select>

    <resultMap id="HistoryInfoMap" type="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" >
        <id column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="partner" property="partner" jdbcType="INTEGER" />
        <result column="user_account" property="userAccount" jdbcType="VARCHAR" />
        <result column="mission_start_time" property="missionStartTime" jdbcType="TIMESTAMP" />
        <result column="mission_end_time" property="missionEndTime" jdbcType="TIMESTAMP" />
        <result column="target_promotion_number" property="targetPromotionNumber" jdbcType="INTEGER" />
        <result column="actual_promotion_number" property="actualPromotionNumber" jdbcType="INTEGER" />
        <result column="target_new_consumer" property="targetNewConsumer" jdbcType="INTEGER" />
        <result column="actual_new_consumer" property="actualNewConsumer" jdbcType="INTEGER" />
    </resultMap>
    <select id="selectHistoryInfo" resultMap="HistoryInfoMap" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
        SELECT
            a.user_id,
            a.partner,
            a.user_account,
            a.mission_start_time,
            a.mission_end_time,
            b.target_new_consumer,
            b.actual_new_consumer,
            b.target_promotion_number,
            b.actual_promotion_number
        FROM
            czb_user a
        LEFT JOIN czb_indicator_record b on  a.user_id=b.user_id
        WHERE
            a.user_id = #{userId,jdbcType=VARCHAR}
        AND DATE_FORMAT(b.indicator_begin_time,'%Y-%m') = DATE_FORMAT(#{monthTime,jdbcType=TIMESTAMP},'%Y-%m')
    </select>

    <select id="selectMyTotalChildMoney" parameterType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO" resultType="com.cqut.czb.bn.entity.dto.infoSpread.PartnerDTO">
         SELECT
            a.user_account AS userAccount,
            b.money AS totalMoney,
            b.type AS `type`,
            b.create_at AS nearTime
        FROM
            czb_user a
        LEFT JOIN czb_consumption_record b ON a.user_id = b.user_id
        WHERE
            (
              a.first_level_partner = #{firstPartner,jdbcType=VARCHAR}
           OR a.second_level_partner = #{secondPartner,jdbcType=VARCHAR}
            ) AND b.money is not null
    </select>

</mapper>