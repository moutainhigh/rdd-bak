<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cqut.czb.bn.dao.mapper.weChatSmallProgram.WeChatStockMapperExtra" >
    <select id="getStockNum" parameterType="com.cqut.czb.bn.entity.dto.WeChatCommodity.PayInputDTO" resultType="java.lang.Integer">
        SELECT count( * ) FROM
	   czb_wechat_stock AS a
	   LEFT JOIN ( SELECT stock_id, GROUP_CONCAT( attr_id ) AS attr_ids FROM
	   czb_wechat_stock_attr GROUP BY stock_id ) AS b ON b.stock_id = a.stock_id
      <where>
          state = 0
          <if test="commodityId != null">
              AND a.commodity_id = #{commodityId,jdbcType=VARCHAR}
          </if>
          <if test="commodityAttrIds != null">
              AND b.attr_ids = #{commodityAttrIds,jdbcType=VARCHAR}
          </if>
      </where>
    </select>
    <select id="getStockId" parameterType="com.cqut.czb.bn.entity.dto.WeChatCommodity.PayInputDTO" resultType="com.cqut.czb.bn.entity.entity.weChatSmallProgram.WeChatStock">
     SELECT
      a.stock_id as stockId,
      a.buyer_id as buyerId,
      a.state as state,
      a.commodity_id as commodityId,
      b.attr_ids as attrIds
     FROM
      czb_wechat_stock AS a
      LEFT JOIN ( SELECT stock_id, GROUP_CONCAT( attr_id ) AS attr_ids FROM czb_wechat_stock_attr GROUP BY stock_id ) AS b ON b.stock_id= a.stock_id
     <where>
         state = 0
         <if test="commodityId != null">
             AND a.commodity_id = #{commodityId,jdbcType=VARCHAR}
         </if>
         <if test="commodityAttrIds != null">
             AND b.attr_ids = #{commodityAttrIds,jdbcType=VARCHAR}
         </if>
     </where>
        LIMIT #{commodityNum,jdbcType=INTEGER}
    </select>
    <select id="selectStockState" parameterType="java.util.List">
        select stock_id,commodity_id,buyer_id,state,content from zcb__wechat_stock
        where state = 2 and stock_id in
        <foreach collection="list" item="item" index="index" separator=",">
            #{item.stockId}
        </foreach>
    </select>

    <update id="updateStock" parameterType="java.util.List">
       <foreach collection="list" item="item" index="index" separator=",">
        UPDATE czb_wechat_stock
        <set>
            buyer_id = #{item.buyerId,jdbcType=VARCHAR},state = 1
        </set>
        WHERE stock_id = #{item.stockId,jdbcType = VARCHAR }
        </foreach>
    </update>

    <update id="upadteStockState" parameterType="java.lang.String">
        UPDATE czb_wechat_stock
        <set>
             state = 2
        </set>
        <where>
            <if test="ownerId != null and ownerId != ''">
                buyer_id = #{ownerId,jdbcType=VARCHAR}
            </if>
            and state = 1
        </where>
    </update>

    <update id="upadte" parameterType="java.util.List">
        <foreach collection="list" item="item" index="index" separator=",">
            UPDATE czb_wechat_stock
            <set>
                state = 0,buyer_id is null
            </set>
            <where>
               stock_id = #{item.stockId,jdbcType=VARCHAR}
            </where>
        </foreach>
    </update>

    <insert id="insertSelective" parameterType="com.cqut.czb.bn.entity.entity.weChatSmallProgram.WeChatCommodityOrder" >
        insert into czb_wechat_commodity_order
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="orderId != null" >
                order_id,
            </if>
            <if test="userId != null" >
                user_id,
            </if>
            <if test="commodityId != null" >
                commodity_id,
            </if>
            <if test="shopId != null" >
                shop_id,
            </if>
            <if test="actualPrice != null" >
                actual_price,
            </if>
            <if test="thirdOrder != null" >
                third_order,
            </if>
            <if test="payStatus != null" >
                pay_status,
            </if>
            <if test="payMethod != null" >
                pay_method,
            </if>
            <if test="remark != null" >
                remark,
            </if>
            <if test="electronicCode != null" >
                electronic_code,
            </if>
            <if test="orderState != null" >
                order_state,
            </if>
            <if test="addressId != null" >
                address_id,
            </if>
            <if test="qrcode != null" >
                qrcode,
            </if>
            <if test="phone != null" >
                phone,
            </if>
            <if test="commoditySource != null" >
                commodity_source,
            </if>
            <if test="fyMoney != null" >
                fy_money,
            </if>
            <if test="costPrice != null" >
                cost_price,
            </if>
            <if test="commodityType != null" >
                commodity_type,
            </if>
            <if test="commmodityTypeId != null" >
                commmodity_type_id,
            </if>
            <if test="processingTime != null" >
                processing_time,
            </if>
            <if test="handler != null" >
                handler,
            </if>
            <if test="commodityNum != null" >
                commodity_num,
            </if>
            <if test="createAt != null" >
                create_at,
            </if>
            <if test="updateAt != null" >
                update_at,
            </if>
            <if test="isSettlement != null" >
                is_settlement,
            </if>
            <if test="isHaveSettled != null" >
                is_have_settled,
            </if>
            <if test="settledRecordId != null" >
                settled_record_id,
            </if>
            <if test="attrInfo != null" >
                attr_info,
            </if>
        </trim>

        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="orderId != null" >
                #{orderId,jdbcType=VARCHAR},
            </if>
            <if test="userId != null" >
                #{userId,jdbcType=VARCHAR},
            </if>
            <if test="commodityId != null" >
                #{commodityId,jdbcType=VARCHAR},
            </if>
            <if test="shopId != null" >
                #{shopId,jdbcType=VARCHAR},
            </if>
            <if test="actualPrice != null" >
                #{actualPrice,jdbcType=DOUBLE},
            </if>
            <if test="thirdOrder != null" >
                #{thirdOrder,jdbcType=VARCHAR},
            </if>
            <if test="payStatus != null" >
                #{payStatus,jdbcType=INTEGER},
            </if>
            <if test="payMethod != null" >
                #{payMethod,jdbcType=INTEGER},
            </if>
            <if test="remark != null" >
                #{remark,jdbcType=VARCHAR},
            </if>
            <if test="electronicCode != null" >
                #{electronicCode,jdbcType=VARCHAR},
            </if>
            <if test="orderState != null" >
                #{orderState,jdbcType=INTEGER},
            </if>
            <if test="addressId != null" >
                #{addressId,jdbcType=VARCHAR},
            </if>
            <if test="qrcode != null" >
                #{qrcode,jdbcType=VARCHAR},
            </if>
            <if test="phone != null" >
                #{phone,jdbcType=VARCHAR},
            </if>
            <if test="commoditySource != null" >
                #{commoditySource,jdbcType=VARCHAR},
            </if>
            <if test="fyMoney != null" >
                #{fyMoney,jdbcType=DOUBLE},
            </if>
            <if test="costPrice != null" >
                #{costPrice,jdbcType=DOUBLE},
            </if>
            <if test="commodityType != null" >
                #{commodityType,jdbcType=INTEGER},
            </if>
            <if test="commmodityTypeId != null" >
                #{commmodityTypeId,jdbcType=VARCHAR},
            </if>
            <if test="processingTime != null" >
                #{processingTime,jdbcType=TIMESTAMP},
            </if>
            <if test="handler != null" >
                #{handler,jdbcType=VARCHAR},
            </if>
            <if test="commodityNum != null" >
                #{commodityNum,jdbcType=INTEGER},
            </if>
            <if test="createAt != null" >
                #{createAt,jdbcType=TIMESTAMP},
            </if>
            <if test="updateAt != null" >
                #{updateAt,jdbcType=TIMESTAMP},
            </if>
            <if test="isSettlement != null" >
                #{isSettlement,jdbcType=INTEGER},
            </if>
            <if test="isHaveSettled != null" >
                #{isHaveSettled,jdbcType=INTEGER},
            </if>
            <if test="settledRecordId != null" >
                #{settledRecordId,jdbcType=VARCHAR},
            </if>
            <if test="attrInfo != null" >
                #{attrInfo,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>

    <select id="selectElectronicCode" resultType="java.lang.String">
    select
    content
    from czb_wechat_stock
    where buyer_id = #{userId,jdbcType=VARCHAR} and state = 1
  </select>
</mapper>