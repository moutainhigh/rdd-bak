<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org// DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cqut.czb.bn.dao.mapper.RentCarMapperExtra">
    <resultMap id="BaseResultMap" type="com.cqut.czb.bn.entity.dto.rentCar.personIncome">
        <result column="fanyong_income" jdbcType="DOUBLE" property="fanYongIncome"></result>
        <result column="share_income" jdbcType="DOUBLE" property="shareIncome"></result>
        <result column="got_total_rent" jdbcType="DOUBLE" property="rentIncome"></result>
        <result column="other_income" jdbcType="DOUBLE" property="otherIncome"></result>
        <result column="withdrawed" jdbcType="DOUBLE" property="withDrawed"></result>
    </resultMap>

    <select id="getPersonIncome" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        fanyong_income,
        share_income,
        got_total_rent,
        other_income,
        withdrawed
        FROM czb_user_income_info
        WHERE user_id = #{userId}
    </select>

    <select id="getOneContractInfo" parameterType="java.lang.String" resultType="com.cqut.czb.bn.entity.dto.rentCar.OneContractInfoDTO">
        SELECT
        cp.car_license AS carLicense,
        cp.identify_code AS identifyCode,
        c.startTime AS startTime,
        c.endTime AS endTime,
        c.State AS status,
        c.num AS contractId,
        c.rent AS rentMoney
        FROM
            czb_cars_persons cp,
            (
                SELECT
                    record_id,
                    third_contract_num num,
                    date_format(contract_start_time, '%Y.%m.%d') startTime,
			        date_format(contract_end_time, '%Y.%m.%d') endTime,
                    contract_state State,
                    rent
                FROM
                    czb_contract_records cc
                WHERE
                    cc.user_id = #{userId}
            ) AS c
        WHERE
        cp.contract_record_id = #{contractId} and c.record_id = #{contractId}
    </select>

    <select id="getPersonalContractList" resultType="com.cqut.czb.bn.entity.dto.rentCar.PersonalContractDTO">
        SELECT
        cp.car_license AS carLicense,
        c.endTime AS endTime,
        c.State AS status,
        c.num AS contractId
        FROM
            czb_cars_persons cp,
            (
                SELECT
                    record_id,
                    third_contract_num num,
                    date_format(contract_start_time, '%Y.%m.%d') startTime,
			        date_format(contract_end_time, '%Y.%m.%d') endTime,
                    contract_state State,
                    rent
                FROM
                    czb_contract_records cc
                WHERE
                    cc.user_id = #{userId}
            ) AS c
        WHERE
        cp.contract_record_id = c.record_id
    </select>

    <!--企业租车服务合同列表获取第一步，少已签约数量-->
    <select id="getCompanyContractList" resultType="com.cqut.czb.bn.entity.dto.rentCar.CompanyContractInfoDTO">
        SELECT
            COUNT(d.dId) as carNum,
            d.num as contractId,
            d.state as status
        FROM
            (
                SELECT
                    cp.person_car_id as dId,
                    cp.car_license as license,
                    c.State,
                    c.num as num
                FROM
                    czb_cars_persons cp,
                    (
                        SELECT
                            record_id,
                            third_contract_num num,
                            contract_state State
                        FROM
                            czb_contract_records cc
                        WHERE
                            cc.user_id = #{userId}
                    ) AS c
                WHERE
                    cp.contract_record_id = c.record_id
            ) d
        GROUP BY  contractId, status
    </select>

    <!--企业租车服务合同列表获取第二步，根据第三方合同id得到已签约数量-->
    <select id="getSignedNumList" resultType="com.cqut.czb.bn.entity.dto.rentCar.ContractAndSignedNumDTO">
        SELECT
            count(cp.person_car_id) AS signedCarNum,
            c.cnum as contractId
        FROM
            czb_cars_persons cp,
            (
                SELECT
                    record_id,
                    cc.third_contract_num as cnum
                FROM
                    czb_contract_records cc
                WHERE
                    cc.user_id = #{userId}
            ) AS c
        WHERE
            cp.contract_record_id = c.record_id AND cp.is_signed = 1
        group by contractId
    </select>

    <select id="getOneCompanyContractInfo" resultType="com.cqut.czb.bn.entity.dto.rentCar.OneCompanyContractsPersonDTO">
        SELECT
            cp.person_name AS personName,
            cp.car_license AS license,
            cp.person_id_card AS carId,
            cp.is_signed AS isSign,
            c.rent AS rent

        FROM
            czb_cars_persons cp,
            (
                SELECT
                    record_id,
                    rent
                FROM
                    czb_contract_records cc
                WHERE
                    cc.user_id = #{userId}
            ) AS c
        WHERE
            cp.contract_record_id = c.record_id
        GROUP BY person_name, license, carId, is_signed, rent
    </select>

    <!--企业合同插入-->
    <insert id="insertContractLog" parameterType="com.cqut.czb.bn.entity.dto.rentCar.ContractLog">
        INSERT INTO czb_contract_records (
            record_id,
            user_id,
            contract_start_time,
            contract_end_time,
            contract_state,
            contract_type,
            signed_time
        )
        VALUES
            (
                #{recordId},
                #{userId},
                #{startTime},
                #{endTime},
                '0',
                '0',
                CURRENT_TIMESTAMP
            )
    </insert>

    <!--个人合同插入-->
    <insert id="insertContractLogPerson" parameterType="com.cqut.czb.bn.entity.dto.rentCar.ContractLog">
        INSERT INTO czb_contract_records (
        record_id,
        user_id,
        contract_start_time,
        contract_end_time,
        contract_state,
        contract_type,
        signed_time,
        rent
        )
        VALUES
        (
        #{recordId},
        #{userId},
        #{startTime},
        #{endTime},
        '0',
        '1',
        CURRENT_TIMESTAMP,
        #{rent}
        )
    </insert>

    <!--企业插入添加的人员信息-->
    <insert id="insertCompanyPerson" parameterType="com.cqut.czb.bn.entity.dto.rentCar.PersonCar">
        INSERT INTO czb_cars_persons (
            person_car_id,
            person_name,
            person_id_card,
            car_license,
            contract_record_id,
            plan_id,
            petrol_type,
            is_signed,
            identify_code,
            create_at,
            update_at
        )
        VALUES
            (
                #{personCarId},
                #{name},
                #{personId},
                #{carNum},
                #{contractId},
                #{serviceId},
                #{petrolType},
                '0',
                #{identityCode},
                CURRENT_TIMESTAMP,
                CURRENT_TIMESTAMP
            )
    </insert>

    <!--个人签订租赁前确认是否已签订-->
    <select id="getIsSigned" resultType="java.lang.Integer">
        SELECT is_signed
        FROM
        czb_cars_persons
        WHERE
        person_id_card = #{personId}
        AND
        identify_code = #{identifyCode}
    </select>

    <!--个人签订租赁-->
    <update id="updateCarPerson" parameterType="java.lang.String">
        UPDATE czb_cars_persons pc
        SET pc.is_signed = 1
        WHERE
            pc.person_id_card = #{personId}
        AND pc.identify_code = #{identifyCode}
    </update>

    <!--查看个人收益-->
    <select id="getPersonalIncome" resultType="com.cqut.czb.bn.entity.dto.rentCar.Income">
        SELECT
            amount,
            date_format(pay_time, '%Y.%m.%d') time
        FROM
            czb_deposit_records
        WHERE
            payer_id = #{userId}
    </select>

</mapper>