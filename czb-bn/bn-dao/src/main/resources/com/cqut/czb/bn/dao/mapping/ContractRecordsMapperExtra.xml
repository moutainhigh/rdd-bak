<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cqut.czb.bn.dao.mapper.ContractRecordsMapperExtra" >
    <!--企业合同和个人合同列表通用接口-->
    <select id="selectContractList" resultType="com.cqut.czb.bn.entity.dto.contractManagement.ContractDTO" parameterType="com.cqut.czb.bn.entity.dto.contractManagement.ContractInputDTO" >
        select
        record_id as 'contractId',
        signed_time as 'signedTime',
        user_name as 'signer',
        contract_state as 'contractState',
        ( case when signed_time is not null then 1 else 0 end ) as 'signState'
        from
        czb_contract_records ccr
        left join czb_user cu on cu.user_id = ccr.user_id
        <where>
          <if test="contractId != null and contractId != ''">
            and contract_id like concat('%', #{contractId, jdbcType=VARCHAR}, '%')
          </if>
          <if test="signBeginTime != null and signEndTime == null">
            and signed_time >= #{signBeginTime, jdbcType=TIMESTAMP}
          </if>
          <if test="signBeginTime == null and signEndTime != null">
            and signed_time &lt;= #{signEndTime, jdbcType=TIMESTAMP}
          </if>
          <if test="signBeginTime != null and signEndTime != null">
            and signed_time between #{signBeginTime, jdbcType=TIMESTAMP} and #{signEndTime, jdbcType=TIMESTAMP}
          </if>
          <if test="signer != null and signer != ''">
            and user_name like concat('%', #{signer, jdbcType=VARCHAR}, '%')
          </if>
          <if test="contractState != null">
            and contract_state = #{contractState, jdbcType=INTEGER}
          </if>
          <if test="contractType != null">
            and contract_type = #{contractType, jdbcType=INTEGER}
          </if>
        </where>
    </select>
    <!--根据个人合同查看企业合同-->
    <select id="selectEnterpriseContract" resultType="com.cqut.czb.bn.entity.dto.contractManagement.ContractDTO" parameterType="java.lang.String">
      select
      record_id as 'contractId',
      signed_time as 'signedTime',
      user_name as 'signer',
      contract_state as 'contractState',
      ( case when signed_time is not null then 1 else 0 end ) as 'signState'
      from
      czb_contract_records ccr
      left join czb_user cu on cu.user_id = ccr.user_id
      <where>
        record_id in (select contract_father_id from czb_contract_records where record_id = #{contractId, jdbcType=VARCHAR})
      </where>
    </select>
    <!--根据企业合同查看个人合同-->
    <select id="selectPersonalContract" resultType="com.cqut.czb.bn.entity.dto.contractManagement.ContractDTO" parameterType="java.lang.String">
      select
      record_id as 'contractId',
      signed_time as 'signedTime',
      user_name as 'signer',
      contract_state as 'contractState',
      ( case when signed_time is not null then 1 else 0 end ) as 'signState'
      from
      czb_contract_records ccr
      left join czb_user cu on cu.user_id = ccr.user_id
      <where>
        contract_father_id = #{contractId, jdbcType=VARCHAR}
      </where>
    </select>
    <!--个人合同详情基本信息-->
    <select id="selectPersonalContractDetail" resultType="com.cqut.czb.bn.entity.dto.contractManagement.PersonalContractDetailDTO" parameterType="java.lang.String">
        select
        record_id as 'contractId',
        signed_time as 'signedTime',
        user_name as 'signer',
        contract_start_time as 'contractStartTime',
        contract_start_time as 'contractEndTime',
        contract_state as 'contractState',
        ( case when signed_time is not null then 1 else 0 end ) as 'signState',
        rent as 'rent',
        got_total_money as 'gotTotalMoney',
        bank_user_name as 'bankUserName',
        bank_of_deposit as 'bankOfDeposit',
        bank_account_num as 'bankAccountNum'
        from
        czb_contract_records ccr
        left join czb_user cu on cu.user_id = ccr.user_id
        <where>
            record_id = #{contractId, jdbcType=VARCHAR}
        </where>
    </select>
    <update id="changeContractState" parameterType="com.cqut.czb.bn.entity.dto.contractManagement.ContractInputDTO" >
        update czb_contract_records
        <set >
            <if test="contractState != null" >
                contract_state = #{contractState,jdbcType=INTEGER},
            </if>
        </set>
        where record_id = #{contractId,jdbcType=VARCHAR}
    </update>

    <select id="selectOwnerId" parameterType="java.lang.String" resultType="com.cqut.czb.bn.entity.dto.appBuyPetrol.PetrolInputDTO">
       SELECT
        czb_contract_records.user_id as owenrId,
        petrol_type as petrolKind,
        czb_address.address_id AS addressId
        FROM czb_contract_records,czb_cars_persons,czb_address
        WHERE
        record_id=#{contractRecordId,jdbcType=VARCHAR} AND
        contract_record_id=record_id AND
        czb_contract_records.contract_father_id=czb_address.user_id AND
        czb_address.is_default=1
    </select>
</mapper>